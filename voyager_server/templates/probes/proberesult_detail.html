{% extends "base.html" %}
{% load static %}

{% block title %}Probe: {{ object.target }}{% endblock %}

{% block content %}
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
<style type="text/css">
    #mynetwork {
      width: 100%;
      height: 500px;
    }
    div#cellBatchAttrPopUp {
        display: none;
        position: absolute;
        z-index: 2000;
        padding: 4px 8px;
        color: #333;
        white-space: nowrap;
        -moz-border-radius: 5px;
        -webkit-border-radius: 5px;
        border-radius: 5px;
        -moz-box-shadow: 0px 0px 4px #222;
        -webkit-box-shadow: 0px 0px 4px #222;
        box-shadow: 0px 0px 4px #222;
        background-image: -moz-linear-gradient(top, #eeeeee, #cccccc);
        background-image: -webkit-gradient(linear,left top,left bottom,color-stop(0, #eeeeee),color-stop(1, #cccccc));
        background-image: -webkit-linear-gradient(top, #eeeeee, #cccccc);
        background-image: -moz-linear-gradient(top, #eeeeee, #cccccc);
        background-image: -ms-linear-gradient(top, #eeeeee, #cccccc);
        background-image: -o-linear-gradient(top, #eeeeee, #cccccc);
    }
</style>
<div id="mynetwork"></div>
<pre id="eventSpan"></pre>

<script type="text/javascript">
var data = {};
$.ajax({
    type:"GET",
    context: data,
    async: false,
    cache :false,
    dataType: "json",
    url: "/api/v1/probe-results/67e6af21-d6cb-4861-8cfb-2ca9589dfd31/jsgraph",
    success: function(resp){
        console.log(resp);
        data = { nodes: resp.nodes, edges: resp.edges };
    }
});

var nodes = new vis.DataSet(data.nodes);

// create an array with edges
var edges = new vis.DataSet(data.edges);

// create a network
var container = document.getElementById('mynetwork');
var data = {
  nodes: nodes,
  edges: edges
};
var options = {
    layout: {
        improvedLayout: true,
        hierarchical: {
          enabled: true,
          levelSeparation: 200,
          nodeSpacing: 100,
          treeSpacing: 200,
          blockShifting: false,
          edgeMinimization: false,
          parentCentralization: true,
          direction: 'LR',        // UD, DU, LR, RL
          sortMethod: 'directed',  // hubsize, directed
          shakeTowards: 'roots'  // roots, leaves
      },
    },
    interaction: {
      hover: true,
      hoverConnectedEdges: true,
    },
    edges: {
      arrows: {
          to: {
              enabled: true, 
              type: "arrow",
              scaleFactor: 1
          }
      }
    },
    nodes: {
        shape: 'dot',
        scaling: {
            min: 20,
            max: 50,
            label: {
                enabled: true,
                min: 24,
                max: 50
            }
        }
    }
};
var network = new vis.Network(container, data, options);
network.on('hoverNode', function (params) {
  console.log(params);
});

network.on('hoverNode', function (properties) {
    console.log(properties);
    var nodeID = properties.node;
    if (nodeID) {

        var sNodeLabel = this.body.nodes[nodeID].options.label
        var sToolTip = this.body.nodes[nodeID].options.ttl;
        var rtt = this.body.nodes[nodeID].options.rtt;

        //use JQUERY to see where the canvas is on the page.
        var canvasPosition = $('.vis-network').position();

        //the properties give x & y relative to the edge of the canvas, not to the whole document.
        /*
        var clickX = properties.pointer.DOM.x + canvasPosition.top;
        var clickY = properties.pointer.DOM.y + canvasPosition.left;
        */
        var clickX = properties.pointer.DOM.x;
        var clickY = properties.pointer.DOM.y;

    //make sure we have a valid div, either clear it or generate one.
        if ($('#cellBatchAttrPopUp').length) {
            $('div#cellBatchAttrPopUp').empty();
        }
        else {
            $('<div id="cellBatchAttrPopUp"></div>').click(function () {
        //clicking the popup hides it again.
                $(this).empty().hide();
            }).css('position','absolute').appendTo("body");
        }

        // put the div over the node, display the tooltip and show it.
        $('div#cellBatchAttrPopUp').append(sNodeLabel)
           .append('<br/>')
           .append('TTL: ' + sToolTip)
           .append('<br/>')
           .append('RTT: ' + rtt + ' ms')
           .css('top', clickY)
            .css('left', clickX)
           .show();

    }
});

</script>
{% endblock content %}

